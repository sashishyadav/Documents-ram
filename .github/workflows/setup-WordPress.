name: Deploy WordPress with LEMP and SSL

on:
  push:
    branches:
      - main

jobs:
  deploy-wordpress:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Install LEMP stack on the server
      - name: Install LEMP and WordPress on Server
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            # Update the server
            sudo apt update && sudo apt upgrade -y
            
            # Install Nginx
            sudo apt install nginx -y
            sudo systemctl start nginx
            sudo systemctl enable nginx
            
            # Install MySQL
            sudo apt install mysql-server -y
            sudo mysql_secure_installation
            
            # Create MySQL database and user for WordPress
            sudo mysql -e "CREATE DATABASE wordpress_db;"
            sudo mysql -e "CREATE USER 'wordpress_user'@'localhost' IDENTIFIED BY 'strong_password';"
            sudo mysql -e "GRANT ALL PRIVILEGES ON wordpress_db.* TO 'wordpress_user'@'localhost';"
            sudo mysql -e "FLUSH PRIVILEGES;"
            
            # Install PHP and necessary extensions
            sudo apt install php-fpm php-mysql php-cli php-curl php-xml -y

            # Download and configure WordPress
            wget https://wordpress.org/latest.tar.gz
            tar -xvzf latest.tar.gz
            sudo mv wordpress /var/www/html/
            sudo chown -R www-data:www-data /var/www/html/wordpress
            sudo chmod -R 755 /var/www/html/wordpress

            # Configure WordPress
            cp /var/www/html/wordpress/wp-config-sample.php /var/www/html/wordpress/wp-config.php
            sed -i "s/database_name_here/wordpress_db/" /var/www/html/wordpress/wp-config.php
            sed -i "s/username_here/wordpress_user/" /var/www/html/wordpress/wp-config.php
            sed -i "s/password_here/strong_password/" /var/www/html/wordpress/wp-config.php

            # Configure Nginx
            echo 'server {
                listen 80;
                server_name yourdomain.com www.yourdomain.com;

                root /var/www/html/wordpress;
                index index.php index.html index.htm;

                location / {
                    try_files $uri $uri/ /index.php;
                }

                location ~ \.php$ {
                    include snippets/fastcgi-php.conf;
                    fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
                    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                    include fastcgi_params;
                }

                location ~ /\.ht {
                    deny all;
                }
            }' | sudo tee /etc/nginx/sites-available/wordpress

            sudo ln -s /etc/nginx/sites-available/wordpress /etc/nginx/sites-enabled/
            sudo nginx -t
            sudo systemctl restart nginx

            # Install Certbot for SSL
            sudo apt install certbot python3-certbot-nginx -y
            sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com --non-interactive --agree-tos -m your-email@example.com

            # Restart services
            sudo systemctl restart nginx
